#############################################################################
#############################################################################
###########  
#########    ECONOMIC VULNERABILITY
#######       
#####    - Script to load the necessary final data files and generate series
###        of visual descriptives.
#

#############################################################################
##### SECTION 1: PROJECT SET UP AND IMPORT LOOKUPS
###

# PROJECT & LIBRARY SET UP
#----------------------------------------------------------------------------
# Prior to running the template for this one-pager, run the following script
#   to load and clean the necessary data files.
# Library should be set beforehand to the following path and read in packages.
#
# To install package, look for source file in folder structure:
#   > install.packages("R:\\Software Add-Ons\\R-library\\NEW 3.6 R-Library\\sp_1.4-1.zip", repos = NULL)
# 
# lib_base="P:\\Working\\Libraries"
# assign(".lib.loc", lib_base, envir = environment(.libPaths))
#
# library(readxl)
# library(readstata13)

library(data.table)
library(sf)
library(rmarkdown)
library(markdown)
library(ggplot2)
library(grid)
library(gridExtra)
library(ggpubr)
library(randomcoloR)
library(knitr)
library(stringr)
library(numDeriv)
library(dplyr)
library(tidyr)
library(tidygraph)
library(kableExtra)
library(scales)
library(plotly)
library(cowplot)
library(readxl)

# wd <- paste0(ifelse(Sys.info()[[1]]=="Linux", paste0("/home/", Sys.info()[[7]], "/Documents"), paste0("/Users/", Sys.info()[[7]])), 
#   "/OneDrive - The University of Liverpool/Local Profiles")
wd <- paste0(ifelse(Sys.info()[[1]]=="Linux", paste0("/home/", Sys.info()[[7]], "/Documents"), paste0("/Users/", Sys.info()[[7]])), 
             "/Dropbox/Research/ADRUK Covid/Local Profiles")
wd.data <- paste0(wd, "/Data")
#----------------------------------------------------------------------------

# SET PALETTES OF COLOURS
#----------------------------------------------------------------------------
# https://www.schemecolor.com/superlative.php

palette <- list()
palette[[1]] <- data.table(rbind(cbind(Colour="Blue", Col="#205D8A", Col_L="#E9EFF3", Col_H="#1A4A6E"),
  cbind(Colour="Green", Col="#33A989", Col_L="#EBF6F3", Col_H="#29876E"),
  cbind(Colour="Yellow", Col="#E3BA58", Col_L="#FCF8EE", Col_H="#B69546"),
  cbind(Colour="Orange", Col="#C77946", Col_L="#F9F2ED", Col_H="#B36D3F"),
  cbind(Colour="Red", Col="#AF4242", Col_L="#F7ECEC", Col_H="#9E3B3B"),
  cbind(Colour="Purple", Col="#802956", Col_L="#F2EAEE", Col_H="#662145")))
palette[[2]] <- c("#E6194B", "#3CB44B", "#FFE119", "#4363D8", "#F58231", "#911EB4",
  "#42D4F4", "#F032E6", "#BFEf45", "#FABED4", "#469990", "#DCBEFF", "#9A6324",
  "#FFFAC8", "#800000", "#AAFFC3", "#808000", "#FFD8B1", "#000075", "#A9A9A9",
  "#000000", "#FFFFFF")

# show_col(palette[[1]]$Col)
# show_col(palette[[1]]$Col_L)
# show_col(palette[[1]]$Col_H)
# show_col(palette[[2]])
#----------------------------------------------------------------------------

# SOURCE LOOKUPS AND CODES
#----------------------------------------------------------------------------
geographic.lookup <- fread(file=paste0(wd.data, "/Boundaries & Lookups/Geographic_Lookup_X.csv"))
LAD_CIS <- fread(file=paste0(wd.data, "/Boundaries & Lookups/Local_Authority_District__May_2020__to_Covid_Infection_Survey__October_2020__Lookup_in_England.csv"))[,c("LAD20CD", "CIS20CD")]
names(LAD_CIS) <- c("LAD_CD", "CIS_CD")
LAD_CA <- fread(file=paste0(wd.data, "/Boundaries & Lookups/Local_Authority_District_to_Combined_Authority__December_2020__Lookup_in_England.csv"))[,c("LAD20CD", "CAUTH20CD", "CAUTH20NM")]
names(LAD_CA) <- c("LAD_CD", "CA_CD", "CA_NM")
LSOA_LEP <- fread(file=paste0(wd.data, "/Boundaries & Lookups/Lower_Layer_Super_Output_Area__2011__to_Local_Enterprise_Partnership__April_2020__Lookup_in_England.csv"), na.strings = c(""))[,c("LSOA11CD", "LEP20CD1", "LEP20NM1", "LEP20CD2", "LEP20NM2")]
names(LSOA_LEP) <- c("LSOA_CD", "LEP_CD1", "LEP_NM1", "LEP_CD2", "LEP_NM2")
geographic.lookup <- merge(geographic.lookup, LAD_CIS, all.x=T, sort=F, by="LAD_CD")
geographic.lookup <- merge(geographic.lookup, LAD_CA, all.x=T, sort=F, by="LAD_CD")
geographic.lookup <- merge(geographic.lookup, LSOA_LEP, all.x=T, sort=F, by="LSOA_CD")
CIS.naming <- fread(file=paste0(wd.data, "/Boundaries & Lookups/CIS_Naming.csv"))
geographic.lookup <- merge(geographic.lookup, CIS.naming, all.x=T, sort=F, by="CIS_CD")
rm(LAD_CIS, LAD_CA, LSOA_LEP, CIS.naming); gc()

SIC.lookup <- fread(file=paste0(wd.data, "/Boundaries & Lookups/SIC_Lookup_X.csv"))
SIC.lookup$Division_CD <- as.character(ifelse(nchar(SIC.lookup$Division_CD)==4, paste0("0", SIC.lookup$Division_CD), paste0(SIC.lookup$Division_CD)))

LDS.lookup <- data.table(rbind(cbind("Southend", c("E06000033"), c("East of England")),
  cbind("Cambridgeshire and Peterborough", c("E07000008", "E07000009", "E07000010", "E07000011", "E07000012", "E06000031"), c("East of England")),
  cbind("Norfolk County Council", c("E07000143", "E07000144", "E07000146", "E07000145", "E07000147", "E07000148", "E07000149"), c("East of England")),
  cbind("Hertfordshire County Council", c("E07000095", "E07000096", "E07000097", "E07000098", "E07000099", "E07000100", "E07000101", "E07000102", "E07000103", "E07000104"), c("East of England")),
  cbind("Portsmouth, Hampshire and Isle of Wight", 
    c("E07000084", "E07000085", "E07000086", "E07000087", "E07000088", "E07000089", "E07000090", "E07000091", "E07000092", "E07000093", "E07000094", "E06000044", "E06000045", "E06000046"), 
    c("South East Public Health")),
  cbind("Surrey; West Sussex", 
    c("E07000207", "E07000208", "E07000209", "E07000210", "E07000211", "E07000212", "E07000213", "E07000214", 
      "E07000215", "E07000216", "E07000217", "E07000061", "E07000062", "E07000063", "E07000064", "E07000065"), c("South East Public Health")),
  cbind("Westminster", c("E09000033", "E09000020"), NA),
  cbind("Harborough District Council", c("E07000131"), NA),
  cbind("Leicester", c("E06000016"), NA),
  cbind("Birmingham and Solihull", c("E08000025", "E08000029"), NA),
  cbind("Nottingham City and Nottinghamshire County Council", c("E06000018", "E07000170", "E07000171", "E07000172", "E07000173", "E07000174", "E07000175", "E07000176"), NA),
  cbind("South Yorkshire Group", c("E08000016", "E08000017", "E08000018", "E08000019"), NA),
  cbind("Bury Council and CCG", c("E08000002"), NA),
  cbind("Liverpool Combined City Region", c("E08000012", "E08000013", "E08000014", "E08000015", "E08000011", "E06000006"), NA),
  cbind("Lincolnshire County Council", c("E07000136", "E07000137", "E07000138", "E07000139", "E07000140", "E07000141", "E07000142"), NA),
  cbind("Hackney", c("E09000012"), NA),
  cbind("City of York", c("E06000014"), NA)))
names(LDS.lookup) <- c("LDS_Name", "LAD_CD", "LDS_Group")

# housing.lookup <- data.table(cbind(type=c("Total", "Detached", "Semi Detached", "Terraced", "Flat", "Other"),
#   order=c(1, 2, 3, 4, 5, 6), colour=c("#000000", palette[[1]][palette[[1]]$Colour %in% c("Blue", "Red", "Yellow", "Green", "Purple")]$Col)))

# SOC.lookup <- fread(file=paste0(wd.data, "/Lookup/SOC_Lookup_X.csv"))
#----------------------------------------------------------------------------

# READ IN SPATIAL BOUNDARIES 
#----------------------------------------------------------------------------
WZ.sp <- st_transform(st_read(paste0(wd.data, "/Boundaries & Lookups/Workplace_Zones_December_2011_Generalised_Clipped_Boundaries_in_England_and_Wales.shp"),
  stringsAsFactors = F, quiet = T), crs=27700)[,c("wz11cd", "lad11cd")]
names(WZ.sp)[names(WZ.sp)=="wz11cd"] <- "WZ_CD"
names(WZ.sp)[names(WZ.sp)=="lad11cd"] <- "LAD_CD"
WZ.sp <- merge(WZ.sp, unique(geographic.lookup[,c("LAD_CD", "LAD_NM", "RGN_CD", "RGN_NM", "CA_CD", "CA_NM", "LEP_CD1", "LEP_NM1", "LEP_CD2", "LEP_NM2", "CIS_CD", "CIS_NM")]),
  all.x=T, sort=F, by="LAD_CD")

# LSOA.sp <- st_transform(st_read(paste0(wd.data, "/Boundaries & Lookups/LSOA_2011_EW_BFC.shp"), 
#   stringsAsFactors = F, quiet = T), crs=27700)[,c("LSOA11CD")]
# names(LSOA.sp)[names(LSOA.sp)=="LSOA11CD"] <- "LSOA_CD"
# LSOA.sp <- merge(LSOA.sp, unique(geographic.lookup[,c("LSOA_CD", "LSOA_NM", "LAD_CD", "LAD_NM", "RGN_CD", "RGN_NM", "CA_CD", "CA_NM", "LEP_CD1", "LEP_NM1", "LEP_CD2", "LEP_NM2", "CIS_CD", "CIS_NM")]), 
#   all.x=T, sort=F, by="LSOA_CD")
# LSOA.sp$area_ha <- as.numeric(st_area(LSOA.sp))*0.0001

LAD.sp <- st_transform(st_read(paste0(wd.data, "/Boundaries & Lookups/Local_Authority_Districts_(December_2020)_UK_BFC.shp"), 
  stringsAsFactors = F, quiet = T), crs=27700)[,c("LAD20CD")]
names(LAD.sp)[names(LAD.sp)=="LAD20CD"] <- "LAD_CD"
LAD.sp <- merge(LAD.sp, unique(geographic.lookup[,c("LAD_CD", "LAD_NM", "RGN_CD", "RGN_NM", "CA_CD", "CA_NM", "LEP_CD1", "LEP_NM1", "LEP_CD2", "LEP_NM2", "CIS_CD", "CIS_NM")]), 
  all.x=T, sort=F, by="LAD_CD")

LEP.sp <- st_transform(st_read(paste0(wd.data, "/Boundaries & Lookups/Local_Enterprise_Partnerships_(April_2020)_Boundaries_EN_BFC.shp"), 
  stringsAsFactors = F, quiet = T), crs=27700)[,c("lep20cd", "lep20nm")]
names(LEP.sp)[names(LEP.sp)=="lep20cd"] <- "LEP_CD1"
names(LEP.sp)[names(LEP.sp)=="lep20nm"] <- "LEP_NM1"
t <- unique(geographic.lookup[,c("RGN_CD", "RGN_NM", "LEP_CD1", "LEP_NM1")])
t <- t[-c(17, 18, 21, 41, 42),]
LEP.sp <- merge(LEP.sp, t, all.x=T, sort=F, by="LEP_CD1"); rm(t)

CA.sp <- st_transform(st_read(paste0(wd.data, "/Boundaries & Lookups/Combined_Authorities_(December_2019)_Boundaries_EN_BFC.shp"),
  stringsAsFactors = F, quiet = T), crs=27700)[,c("cauth19cd", "cauth19nm")]
names(CA.sp)[names(CA.sp)=="cauth19cd"] <- "CA_CD"
names(CA.sp)[names(CA.sp)=="cauth19nm"] <- "CA_NA"
CA.sp <- merge(CA.sp, unique(geographic.lookup[,c("RGN_CD", "RGN_NM", "CA_CD", "CA_NM")]),
  all.x=T, sort=F, by="CA_CD")

RGN.sp <- st_transform(st_read(paste0(wd.data, "/Boundaries & Lookups/Regions_(December_2019)_Boundaries_EN_BFC.shp"), 
  stringsAsFactors = F, quiet = T), crs=27700)[,c("rgn19cd", "rgn19nm")]
names(RGN.sp)[names(RGN.sp)=="rgn19cd"] <- "RGN_CD"
names(RGN.sp)[names(RGN.sp)=="rgn19nm"] <- "RGN_NM"

# Retail.sp <- st_transform(st_read(gsub("ADRUK Covid/Local Profiles", "Retail/Exports/Pre Release/Retail_Centres_UK_v2.gpkg", wd), 
#   stringsAsFactors = F, quiet = T), crs=27700)
# names(Retail.sp)[names(Retail.sp)=="geom"] <- c("geometry")
# st_geometry(Retail.sp) <- "geometry"
# t <- fread(gsub("ADRUK Covid/Local Profiles", "Retail/Exports/Pre Release/Retail_Centres_Statistics.csv", wd))
# Retail.sp <- merge(Retail.sp, t[,c("RC_ID")], all.x=T, sort=F, by="RC_ID")
# 
# CIS.sp <- st_transform(st_read(paste0(wd.data, "/Boundaries & Lookups/Covid_Infection_Survey__October_2020__EN_BFC.shp"), 
#   stringsAsFactors = F, quiet = T), crs=27700)[,c("CIS20CD")]
#----------------------------------------------------------------------------

# SET UP SUBSET OF LADs FOR BATCH GENERATING
#----------------------------------------------------------------------------
# TO EVENTUALLY RUN ON THE FULL SET OF LADs (OR LDS SPECIFIC)
# local.profiles <- unique(geographic.lookup$LAD_CD)[!is.na(unique(geographic.lookup$LAD_CD))]
# local.profiles <- unique(LDS.lookup$LAD_CD)
#
# FIGURE 3 DOES NOT RUN WITH THESE LADs - THEY ARE PREVIOUS CODES AND NOT UPDATED
# c("E06000053", "E06000029", "E07000051", "E07000049", "E07000205", "E07000190", 
#   "E06000028", "E07000201", "E07000206", "E07000204", "E07000053", "E07000052", 
#   "E07000191", "E07000191", "E07000048", "E07000050")
#
# TEST LADs TO RUN FROM EACH REGION
# E08000025  Birmingham        West Midlands
# E06000014  York              Yorkshire and The Humber
# E09000033  Westminster       London
# E06000033  Southend-on-Sea   East of England
# E08000011  Knowsley          North West (Liverpool CA)
# E08000012  Liverpool         North West (Liverpool CA)
# E08000013  St. Helens        North West (Liverpool CA)
# E08000014  Sefton            North West (Liverpool CA)
# E08000015  Wirral            North West (Liverpool CA)
# E06000006  Halton            North West (Liverpool CA)

local.profiles <- c("E09000033", "E08000025", "E06000033", "E06000014",
  "E08000012", "E08000013", "E08000014", "E08000015", "E08000011", "E06000006")
#----------------------------------------------------------------------------

#############################################################################
##### SECTION 2: LOAD IN AND FORMAT CLEANED (NON-DISCLOSIVE) DATASETS
###

# BICS SUBNATIONAL
#----------------------------------------------------------------------------


#----------------------------------------------------------------------------

# JOB ADVERTS
#----------------------------------------------------------------------------
ads.IND <- fread(file=paste0(wd.data, "/Retail & Fast Indicators/JobAdverts_Sectors.csv"))
ads.RGN <- fread(file=paste0(wd.data, "/Retail & Fast Indicators/JobAdverts_Regions.csv"))

best.match <- 
#----------------------------------------------------------------------------


# SHIPPING AND PORT TRAFFIC
#----------------------------------------------------------------------------
shipping <- fread(file=paste0(wd.data, "/Retail & Fast Indicators/Shipping_Weekly.csv"))

Date	Event
26/04/19 & 27/04/19	Storm Hannah
2019-08-10	High winds
2019-12-25	Christmas day
2020-02-09	Storm Ciara
2020-04-13	Easter Monday
2020-08-21	Storm Ellen
2020-08-25	Storm Francis
2020-10-03	Storm Alex
2020-10-31	Storm Aiden
2021-02-06	Storm Darcy

2020-03-17	FCO advises against all non-essential travel overseas
2020-06-08	UK international travel quarentine begins
2020-07-10	Travel corridors to 59 countries come into force

"Grimsby_Immingham"
c(53.62718, -0.19097)

"London"


Southampton
Liverpool
Milford_Haven
Feli stowe
Tees & Hartlepool
Forth
Dover
Belfast
Holyhead
Larne
Warrenpoint
Portsmouth
Tyne
Hull
#----------------------------------------------------------------------------


# LFS / APS
#----------------------------------------------------------------------------


#----------------------------------------------------------------------------


# JOB EXPOSURE MATRIX
#----------------------------------------------------------------------------


#----------------------------------------------------------------------------







#############################################################################
##### FIGURE X: JOB ADVERTS
###



#############################################################################
##### FIGURE X: UNEMPLOYMENT RATES BY SIC/ SOC
###


#############################################################################
##### FIGURE X: JOB EXPOSURE MATRIX
###




#############################################################################
##### FIGURE X: SHIPPING VOLUMES - CARGO AND TANKERS
###







#############################################################################
##### FIGURE X: JOB EXPOSURE MATRIX
###


#----------------------------------------------------------------------------



#----------------------------------------------------------------------------
